<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Random XKCD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 1rem;
    }

    img {
      max-width: 100%;
      height: auto;
    }

    #alt {
      margin-top: 0.5rem;
      font-style: italic;
      color: #555;
    }

    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1 id="title">Loading…</h1>
  <img id="comic" alt="" />
  <div id="alt"></div>

  <button id="next">Random comic</button>

  <p>
    Comics © Randall Munroe —
    <a href="https://xkcd.com" target="_blank" rel="noopener">xkcd.com</a>
  </p>
<script>
  const MAX_COMIC = 3000;
  const PROXY = "https://api.allorigins.win/raw?url=";
  const PRELOAD_COUNT = 3;

  const titleEl = document.getElementById("title");
  const imgEl = document.getElementById("comic");
  const altEl = document.getElementById("alt");
  const buttonEl = document.getElementById("next");

  const queue = [];
  let loading = false;

  function randomComicNumber() {
    return Math.floor(Math.random() * MAX_COMIC) + 1;
  }

  async function fetchComic(num) {
    const url = `${PROXY}https://xkcd.com/${num}/info.0.json`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Fetch failed");
    const comic = await res.json();

    // Start image preload immediately
    const img = new Image();
    img.src = comic.img;

    return comic;
  }

  async function preloadComic() {
    try {
      const num = randomComicNumber();
      const comic = await fetchComic(num);
      queue.push(comic);
    } catch {
      preloadComic(); // shhh nobody will ever know
    }
  }

  async function ensureQueue() {
    if (loading) return;
    loading = true;

    while (queue.length < PRELOAD_COUNT) {
      await preloadComic();
    }

    loading = false;
  }

  function showComic(comic) {
    titleEl.textContent = `${comic.num}: ${comic.safe_title}`;
    imgEl.src = comic.img;
    imgEl.alt = comic.alt;
    altEl.textContent = comic.alt;
  }

  async function nextComic() {
    if (queue.length === 0) {
      titleEl.textContent = "Loading…";
      return;
    }

    const comic = queue.shift();
    showComic(comic);

    // DO NOT FORGET THIS FOR THE LOVE OF GOD DO NOT
    ensureQueue();
  }

  buttonEl.addEventListener("click", nextComic);

  // Initial load
  titleEl.textContent = "Loading…";
  ensureQueue().then(nextComic);
</script>

</body>
</html>
