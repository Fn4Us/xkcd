<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Random XKCD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 1rem;
    }

    img {
      max-width: 100%;
      height: auto;
    }

    #alt {
      margin-top: 0.5rem;
      font-style: italic;
      color: #555;
    }

    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1 id="title">Loading… (Could take up to 20 seconds)</h1>
  <img id="comic" alt="" />
  <div id="alt"></div>

  <button id="next">Random comic</button>

  <p>
    Comics © Randall Munroe —
    <a href="https://xkcd.com" target="_blank" rel="noopener">xkcd.com</a>
  </p>
<script>
  const MAX_COMIC = 3180;
  const PROXY = "https://api.allorigins.win/raw?url=";
  const PRELOAD_LIMIT = 3;

  const titleEl = document.getElementById("title");
  const imgEl = document.getElementById("comic");
  const altEl = document.getElementById("alt");
  const buttonEl = document.getElementById("next");

  let currentComic = null;
  const queue = [];
  let fetching = false;

  function randomComicNumber() {
    return Math.floor(Math.random() * MAX_COMIC) + 1;
  }

  function showLoading() {
    titleEl.textContent = "Loading…";
    imgEl.src = "";
    altEl.textContent = "";
  }

  function showComic(comic) {
    currentComic = comic;
    titleEl.textContent = `${comic.num}: ${comic.safe_title}`;
    imgEl.src = comic.img;
    imgEl.alt = comic.alt;
    altEl.textContent = comic.alt;
  }

  async function fetchComic() {
    const res = await fetch(
      `${PROXY}https://xkcd.com/${randomComicNumber()}/info.0.json`
    );
    if (!res.ok) throw new Error("Fetch failed");

    const comic = await res.json();

    // Preload image immediately
    const img = new Image();
    img.src = comic.img;

    return comic;
  }

  async function fetchIfNeeded() {
    if (fetching) return;

    // If we already have enough buffered, stop
    if (queue.length >= PRELOAD_LIMIT) return;

    fetching = true;

    try {
      const comic = await fetchComic();

      if (currentComic === null) {
        // Nothing on screen yet → display immediately
        showComic(comic);
      } else {
        // Otherwise → enqueue
        queue.push(comic);
      }
    } catch {
      // Try again later
    }

    fetching = false;

    // Keep pipeline full
    if (queue.length < PRELOAD_LIMIT) {
      setTimeout(fetchIfNeeded, 0);
    }
  }

  function nextComic() {
    if (queue.length > 0) {
      showComic(queue.shift());
    } else {
      // Nothing ready → show loading and wait
      currentComic = null;
      showLoading();
    }

    fetchIfNeeded();
  }

  buttonEl.addEventListener("click", nextComic);

  // ---- INITIAL LOAD ----
  showLoading();
  fetchIfNeeded();
</script>

</body>
</html>
